<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../moe-style/moe-style.html">
<link rel="import" href="../moe-article-list/moe-article-list.html">
<link rel="import" href="../moe-board-header/moe-board-header.html">
<link rel="import" href="../moe-media-query/moe-media-query.html">
<dom-module id="moe-board">
    <style>
    :host {
        display: block;
        box-sizing: border-box;
        background-color: var(--background-color);
        /*@apply(--user-select-disable);*/
    }
    
    :host([queryState=mobile]) {
        --moe-comment-font-size: 12px;
    }
    
    #header {}
    
    #articleList {
        margin: 0 auto 45px auto;
    }
    
    #board[scape=full] {
        @apply(--scape-full);
    }
    
    #board[scape=default] {
        @apply(--scape-default);
        @apply(--layout-center);
    }
    
    #navbar {
        --paper-toolbar-background: rgba(255, 255, 255, 0.3);
        --paper-toolbar-color: var(--font-color);
    }
    </style>
    <template>
        <moe-media-query on-querystate-changed="_queryState"></moe-media-query>
        <paper-drawer-panel disable-swipe right-drawer force-narrow drawer-width="100vw" id="drawerPanel" on-selected-changed="_articleDrawerOpend">
            <!-- 抽屜：右：文章閱讀器 -->
            <paper-header-panel drawer id="drawer">
                <paper-toolbar justify="justified">
                    <paper-icon-button icon="icons:arrow-back" on-tap="_closeArticle">
                    </paper-icon-button>
                    <div style="text-align: left;">
                        <span>回應模式</span>
                    </div>
                    <paper-icon-button icon="icons:reply" on-tap="_closeArticle">
                    </paper-icon-button>
                </paper-toolbar>
                <!-- 放置在 drawer 中的文章 -->
                <p> Moe-article </p>
            </paper-header-panel>
            <!-- 主要：版面 -->
            <paper-scroll-header-panel id="main" main on-content-scroll="_onScroll">
                <!-- 導覽列 -->
                <paper-toolbar id="navbar" justify="justified">
                    <paper-icon-button icon="menu" on-tap="_toggleParentDrawer"> </paper-icon-button>
                    <div id="topLink" class="flex">
                        <ul>
                            <li><a href="#">anchor</a></li>
                            <li><a href="#">background</a></li>
                            <li><a href="#">dialog</a></li>
                            <li><a href="#">element</a></li>
                            <li><a href="#">frame</a></li>
                        </ul>
                    </div>
                    <paper-icon-button data-dialog="scrolling" icon="icons:more-vert" on-click="clickHandler"> </paper-icon-button>
                </paper-toolbar>
                <!-- 版面 -->
                <!-- <moe-board-header id="header"></moe-board-header> -->
                <moe-article-list id="articleList" on-open-article="_openArticle"></moe-article-list>
            </paper-scroll-header-panel>
        </paper-drawer-panel>
    </template>
</dom-module>
<script>
Polymer({

    is: 'moe-board',

    properties: {
        scape: {
            type: String,
            observer: '_scape'
        },
        queryState: {
            type: String,
            reflectToAttribute: true
        },
        articleDrawerOpend: {
            type: Boolean,
            reflectToAttribute: true,
            notify: true
        }
    },
    listeners: {
        'drawer.track': '_onTrack'
    },

    ready: function() {
        this.loadArticles();
    },
    // 捲到底部觸發 讀入文章陣列
    addArticle: function() {
        var t = this.$.articleList;
        t.push('articles', t.articles[0]);
    },
    loadArticles: function() {
        this.$.articleList.articles = [{
            serial: 54764654,
            identity: 'dIW12Afc',
            commentTitle: "不會游泳怎麼辦?",
            username: "無名",
            content: '<a href="http://homu.komica.org/00/index.php?res=6503972">http://homu.komica.org/00/index.php?res=6503972</a><br><blockquote>會說初音過氣八成對這塊認識也不深</blockquote>有什麼數據來證明初音還沒過氣阿?<br>新投稿的作品數和再生數都逐年激減了耶<br> 布丁好吃',
            comments: [{
                serial: 123456,
                commentTitle: "不會游泳怎麼辦?",
                userName: "無名",
                content: '<a href="http://homu.komica.org/00/index.php?res=6503972">http://homu.komica.org/00/index.php?res=6503972</a><br><blockquote>會說初音過氣八成對這塊認識也不深</blockquote>有什麼數據來證明初音還沒過氣阿?<br>新投稿的作品數和再生數都逐年激減了耶<br> 布丁好吃',
                imgNo: "01",
            }, {
                serial: 123456,
                commentTitle: "不會游泳怎麼辦?",
                userName: "無名",
                content: "<a class='post-number'>NO.1234</a>不會游泳，現在要進去海陸新訓了........<br>覺這一年當兵生活會很慘",
                imgNo: "01",
            }, {
                serial: 45623,
                commentTitle: "ㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZㄈㄓZ",
                userName: "ㄈㄓZ",
                content: "李嫌和王女原本約在高鐵台南站見面，因鄰居發現王母失蹤",
                imgNo: "02",

                CLASS: "highlight"
            }, {
                serial: "78,645,456",
                commentTitle: "",
                userName: "",
                content: "外來種賤女狗公惱羞開始血尿跳針哭哭ㄛwwwwww<br>護航乙",
                imgNo: "03",
            }, {
                serial: 456456,
                commentTitle: "",
                userName: "",
                content: "<blockquote>搞不好李搞不好李搞不好李搞不好李搞不好李搞</blockquote>不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李w好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李搞不好李嫌跟王女真的有交往過<br>因為某某原因而否認了<br>就跟以前認識某女明明就有暗示我告白<br>結果我沒告白就到處抹黒我說我有嚴重妄想症一樣",
                imgNo: "04",
            }, {
                serial: 353453,
                commentTitle: "",
                userName: "",
                content: "無本文",
                imgNo: "15",
            }, {
                serial: 453,
                commentTitle: "",
                userName: "",
                content: "<a href='#'>www.google.com</a>為什麼支那賤畜一聽到台灣女生說話就射啦<br>我剛剛無聊上百度搜尋台灣女生，發現很多426很哈台灣的劍",
                imgNo: "16",
            }, {
                serial: 123456,
                commentTitle: "",
                userName: "",
                content: "問一下 問答板為什麼只能設3個問題? 我看其他人都25題耶",
                imgNo: "17",
            }, {
                serial: 453453,
                commentTitle: "",
                userName: "",
                content: "有島民學過速讀嗎?<br>我想要自學卻不知道要怎麼入門",
                imgNo: "18",
            }, {
                serial: 51245,
                commentTitle: "",
                userName: "",
                content: "有島民知道拿熱水沖屁眼完5分鐘在拿冷水沖是什麼感覺嗎",
                imgNo: "",
            }, {
                serial: 7857853435,
                commentTitle: "",
                userName: "",
                content: "有什麼地方可以吹冷氣又有插座?",
                imgNo: "20",
            }]
        }];
    },
    // 捲動至下方剩下兩個螢幕高時 載入文章
    _onScroll: function(e) {
        var t = this;
        var docY = e.target.scroller.scrollHeight; // scroll panel height
        var screenY = window.screen.height; // brower window height
        var winTop = e.target.scroller.scrollTop; // scroll panel offsetTop position 
        // console.log(docY + ' | ' + screenY + ' | ' + winTop + ' | ' + (docY - screenY * 2));
        (docY - screenY * 2) <= winTop ? t.addArticle() : console.log('error');
    },
    // 調整版面 width 固定寬度 | 100%
    _scape: function(e) {
        switch (e) {
            case 'scape-full':
                this.toggleAttribute('scape', 'full', this.$.board);
                break;
            case 'scape-default':
                this.toggleAttribute('scape', 'default', this.$.board);
                break;
        }
    },
    _openArticle: function() {
        this.$.drawerPanel.openDrawer();
    },
    _closeArticle: function() {
        this.$.drawerPanel.closeDrawer();
    },
    _toggleParentDrawer: function() {
        this.fire('toggle-parent-drawer');
    },

    // 回傳 文章閱讀抽屜開啟狀態
    _articleDrawerOpend: function(e) {
        this.articleDrawerOpend = e.detail.value === 'drawer' ? true : false;
    },

    // 改寫 drawer-panel 的 Track Event 給 右方 article drawer panel 
    _onTrack: function(e) {
        var t = this.$.drawerPanel;
        var x = e.detail.x;
        var dx = e.detail.dx;
        switch (e.detail.state) {
            case 'start':
                if (x <= 30) {
                    console.log('start');
                    t._setDragging(true);
                }

                break;
            case 'track':
                if (t.dragging) {
                    t.transition = false;
                    t._moveDrawer(t._translateXForDeltaX(x));
                    console.log('track');
                }
                break;
            case 'end':
                if (t.dragging) {
                    var xDirection = dx > (t.offsetWidth / 2);
                    t.transition = true;
                    t._setDragging(false);
                    t._moveDrawer(null);
                    t[xDirection ? 'closeDrawer' : 'openDrawer']();
                    console.log('end');
                }
                break;
        }
    },
    // 監控 media query 調整 queryState propertie
    _queryState: function(e) {
        switch (e.detail.value) {
            case 'desktop':
                this.queryState = '';
                break;
            case 'mobile-portrait':
                this.queryState = 'mobile';
                break;
            case 'mobile-landscape':
                this.queryState = 'mobile';
                break;
        }
    }
});
</script>
